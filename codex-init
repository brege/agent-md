#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

src_template="$SCRIPT_DIR/shared/base-AGENTS.md"
src_claude="$SCRIPT_DIR/shared/base-CLAUDE.md"
src_settings="$SCRIPT_DIR/shared/base-settings.json"

if [[ ! -f "$src_template" ]]; then
    echo "error: $src_template not found" >&2
    exit 1
fi

if [[ ! -f "$src_claude" ]]; then
    echo "error: $src_claude not found" >&2
    exit 1
fi

if [[ ! -f "$src_settings" ]]; then
    echo "error: $src_settings not found" >&2
    exit 1
fi

# Create temp files
tmp_local=$(mktemp)
tmp_instr=$(mktemp)
tmp_restr=$(mktemp)
tmp_out=$(mktemp)
trap "rm -f $tmp_local $tmp_instr $tmp_restr $tmp_out" EXIT

# Process local CLAUDE.md if it exists
if [[ -f "./.claude/CLAUDE.md" ]]; then
    while IFS= read -r line; do
        if [[ $line =~ ^@instructions/(.+)\.md$ ]]; then
            include_file="$SCRIPT_DIR/instructions/${BASH_REMATCH[1]}.md"
            if [[ -f "$include_file" ]]; then
                tail -n +2 "$include_file" | awk 'NF {p=1} p'
            else
                echo "$line"
            fi
        else
            echo "$line"
        fi
    done < "./.claude/CLAUDE.md" > "$tmp_local"
fi

# Expand @instructions/* references in base CLAUDE.md
while IFS= read -r line; do
    if [[ $line =~ ^@instructions/(.+)\.md$ ]]; then
        include_file="$SCRIPT_DIR/instructions/${BASH_REMATCH[1]}.md"
        if [[ -f "$include_file" ]]; then
            tail -n +2 "$include_file" | awk 'NF {p=1} p'
        else
            echo "$line"
        fi
    else
        echo "$line"
    fi
done < "$src_claude" > "$tmp_instr"

# Build restrictions from settings (base + local)
{
    echo "## Enforced Restrictions"
    echo ""

    # Collect and deduplicate deny rules from base and local settings
    {
        jq -r '.permissions.deny[]' "$src_settings" 2>/dev/null
        if [[ -f "./.claude/settings.local.json" ]]; then
            jq -r '.permissions.deny[]' "./.claude/settings.local.json" 2>/dev/null
        fi
    } | sort -u | while read -r rule; do
        case "$rule" in
            Bash\(*) cmd="${rule#Bash(}"; cmd="${cmd%:*)}"; echo "- Never run '$cmd' or any command matching it." ;;
            Read\(*) path="${rule#Read(}"; path="${path%) }"; echo "- Never read files matching $path." ;;
            Edit\(*) path="${rule#Edit(}"; path="${path%) }"; echo "- Never edit files matching $path." ;;
            Write\(*) path="${rule#Write(}"; path="${path%) }"; echo "- Never write to files matching $path." ;;
            Glob\(*) path="${rule#Glob(}"; path="${path%) }"; echo "- Never enumerate file paths matching $path." ;;
            *) echo "- Deny: $rule" ;;
        esac
    done
} > "$tmp_restr"

# Replace @agent-title in instructions content
sed -i "s/@agent-title/# Codex Agent Configuration/" "$tmp_instr"

# Replace templates in base-AGENTS.md
cp "$src_template" "$tmp_out"

# Handle @local-claude
if [[ -s "$tmp_local" ]]; then
    sed -i "/@local-claude/r $tmp_local" "$tmp_out"
fi
sed -i "/@local-claude/d" "$tmp_out"

# Handle @instructions and @restrictions
sed -i "/@instructions/r $tmp_instr" "$tmp_out"
sed -i "/@instructions/d" "$tmp_out"
sed -i "/@restrictions/r $tmp_restr" "$tmp_out"
sed -i "/@restrictions/d" "$tmp_out"

mv "$tmp_out" AGENTS.md

echo "Generated AGENTS.md from agent-configs"
