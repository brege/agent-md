#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CLAUDE_DIR="$HOME/.claude"

mkdir -p "$CLAUDE_DIR"

echo "Initializing global Claude Code configuration..."

# Remove old symlinks/directories and create fresh directories with merged content
rm -rf "$CLAUDE_DIR/instructions" "$CLAUDE_DIR/agents"
mkdir -p "$CLAUDE_DIR/instructions" "$CLAUDE_DIR/agents"

# Copy instruction files with user augmentation
if [[ -d "$REPO_DIR/prompts/partials/instructions" ]]; then
    while IFS= read -r src_file; do
        filename=$(basename "$src_file")
        dest_file="$CLAUDE_DIR/instructions/$filename"
        user_file="$REPO_DIR/user/prompts/partials/instructions/$filename"

        if [[ -f "$user_file" ]] && head -1 "$user_file" | grep -q "^@override"; then
            tail -n +2 "$user_file" > "$dest_file"
        else
            {
                cat "$src_file"
                if [[ -f "$user_file" ]]; then
                    echo ""
                    cat "$user_file"
                fi
            } > "$dest_file"
        fi
    done < <(find "$REPO_DIR/prompts/partials/instructions" -maxdepth 1 -type f -name "*.md")
fi

# Copy agent files with user augmentation
if [[ -d "$REPO_DIR/prompts/partials/agents" ]]; then
    while IFS= read -r src_file; do
        filename=$(basename "$src_file")
        dest_file="$CLAUDE_DIR/agents/$filename"
        user_file="$REPO_DIR/user/prompts/partials/agents/$filename"

        if [[ -f "$user_file" ]] && head -1 "$user_file" | grep -q "^@override"; then
            tail -n +2 "$user_file" > "$dest_file"
        else
            {
                cat "$src_file"
                if [[ -f "$user_file" ]]; then
                    echo ""
                    cat "$user_file"
                fi
            } > "$dest_file"
        fi
    done < <(find "$REPO_DIR/prompts/partials/agents" -maxdepth 1 -type f -name "*.md")
fi

# Copy CLAUDE.md template
src="$REPO_DIR/prompts/CLAUDE.md"
dest="$CLAUDE_DIR/CLAUDE.md"
if [[ ! -f "$dest" ]] || ! cmp -s "$src" "$dest"; then
    cp "$src" "$dest"
    echo "updated: CLAUDE.md"
fi

# Merge and copy settings.json
dest="$CLAUDE_DIR/settings.json"

if [[ -f "$REPO_DIR/user/settings/settings.json" ]] && jq -e '.override == true' "$REPO_DIR/user/settings/settings.json" >/dev/null 2>&1; then
    jq 'del(.override)' "$REPO_DIR/user/settings/settings.json" > "$dest"
    echo "updated: settings.json (override)"
else
    {
        jq -s '.[0] as $base | {
          includeCoAuthoredBy: $base.includeCoAuthoredBy,
          permissions: {
            deny: ([.[].permissions.deny // []] | add)
          },
          model: $base.model,
          alwaysThinkingEnabled: $base.alwaysThinkingEnabled
        }' "$REPO_DIR/settings/settings.json" "$REPO_DIR/settings/partials"/*.json "$REPO_DIR/user/settings/partials"/*.json 2>/dev/null || cat "$REPO_DIR/settings/settings.json"
    } > "$dest"
    echo "updated: settings.json"
fi

# Generate command-restrictions.md from settings.json deny rules
{
    echo "# Command Restrictions"
    echo ""
    jq -r '.permissions.deny[]' "$dest" | sort -u | while read -r rule; do
        case "$rule" in
            Bash\(*) cmd="${rule#Bash(}"; cmd="${cmd%:*)}"; echo "- Never run '$cmd' or any command matching it." ;;
            Read\(*) path="${rule#Read(}"; path="${path%)}"; echo "- Never read files matching $path." ;;
            Edit\(*) path="${rule#Edit(}"; path="${path%)}"; echo "- Never edit files matching $path." ;;
            Write\(*) path="${rule#Write(}"; path="${path%)}"; echo "- Never write to files matching $path." ;;
            Glob\(*) path="${rule#Glob(}"; path="${path%)}"; echo "- Never enumerate file paths matching $path." ;;
            *) echo "- Deny: $rule" ;;
        esac
    done
    if [[ -f "$REPO_DIR/user/prompts/partials/instructions/command-restrictions.md" ]]; then
        echo ""
        cat "$REPO_DIR/user/prompts/partials/instructions/command-restrictions.md"
    fi
} > "$CLAUDE_DIR/instructions/command-restrictions.md"

echo "Done. Global configuration initialized."
