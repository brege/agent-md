#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later
# Orchestrator for Claude Code configuration initialization

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CLAUDE_DIR="$HOME/.claude"
LIB_DIR="$REPO_DIR/lib"

mkdir -p "$CLAUDE_DIR"

echo "claude: Preparing config merging with dist and user."

# Remove old symlinks/directories and create fresh directories with merged content
rm -rf "$CLAUDE_DIR/instructions" "$CLAUDE_DIR/agents"
mkdir -p "$CLAUDE_DIR/instructions" "$CLAUDE_DIR/agents"

# Run generic handlers
"$LIB_DIR/instructions" "$REPO_DIR" "$CLAUDE_DIR"
"$LIB_DIR/agents" "$REPO_DIR" "$CLAUDE_DIR"
"$LIB_DIR/settings" "$REPO_DIR" "$CLAUDE_DIR"

# Copy CLAUDE.md template
src="$REPO_DIR/dist/CLAUDE.md"
dest="$CLAUDE_DIR/CLAUDE.md"
if [[ ! -f "$dest" ]] || ! cmp -s "$src" "$dest"; then
    cp "$src" "$dest"
    echo "claude: Global CLAUDE.md updated."
fi

# Run special-case handlers from instructions.d/ (distribution first, then user)
for instructions_dir in "$LIB_DIR/instructions.d" "$REPO_DIR/user/lib/instructions.d"; do
    if [[ -d "$instructions_dir" ]]; then
        while IFS= read -r handler; do
            [[ -x "$handler" ]] && "$handler" "$REPO_DIR" "$CLAUDE_DIR"
        done < <(find "$instructions_dir" -maxdepth 1 -type f -perm -u+x | sort)
    fi
done

echo "claude: Done."
