#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

stash_files=()

stash_mode=0

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            echo "Usage: agent-md [options]"
            echo ""
            echo "Options:"
            echo "  -s, --stash [files]    stash local config files (CLAUDE.local.md, AGENTS.md, ..)"
            echo "  -h, --help             show this help text"
            exit 0
            ;;
        -s|--stash)
            stash_mode=1
            shift
            while [[ $# -gt 0 ]] && [[ "$1" != -* ]]; do
                stash_files+=("$1")
                shift
            done
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

if [[ $stash_mode -eq 1 ]]; then
    if [[ ${#stash_files[@]} -eq 0 ]]; then
        for file in CLAUDE.md CLAUDE.local.md AGENTS.md .claude/settings.local.json; do
            [[ -f "$file" ]] && stash_files+=("$file")
        done
        if [[ ${#stash_files[@]} -eq 0 ]]; then
            echo "No config files found to stash"
            exit 0
        fi
    fi
    "$REPO_DIR/lib/stash" "$REPO_DIR" "${stash_files[@]}"
else
    "$SCRIPT_DIR/claude-md"
    "$SCRIPT_DIR/codex-md"
fi
