#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

src_template="$REPO_DIR/prompts/AGENTS.md"
src_claude="$REPO_DIR/prompts/CLAUDE.md"
src_settings="$REPO_DIR/settings/settings.json"

if [[ ! -f "$src_template" ]]; then
    echo "error: $src_template not found" >&2
    exit 1
fi

if [[ ! -f "$src_claude" ]]; then
    echo "error: $src_claude not found" >&2
    exit 1
fi

if [[ ! -f "$src_settings" ]]; then
    echo "error: $src_settings not found" >&2
    exit 1
fi

# Create temp files
tmp_local=$(mktemp)
tmp_instr=$(mktemp)
tmp_restr=$(mktemp)
tmp_out=$(mktemp)
trap "rm -f $tmp_local $tmp_instr $tmp_restr $tmp_out" EXIT

# Process local CLAUDE.md if it exists
if [[ -f "./.claude/CLAUDE.md" ]]; then
    while IFS= read -r line; do
        if [[ $line =~ ^@instructions/(.+)\.md$ ]]; then
            include_file="$REPO_DIR/prompts/partials/instructions/${BASH_REMATCH[1]}.md"
            if [[ -f "$include_file" ]]; then
                tail -n +2 "$include_file" | awk 'NF {p=1} p'
            else
                echo "$line"
            fi
        else
            echo "$line"
        fi
    done < "./.claude/CLAUDE.md" > "$tmp_local"
fi

# Expand @instructions/* references in base CLAUDE.md
while IFS= read -r line; do
    if [[ $line =~ ^@instructions/(.+)\.md$ ]]; then
        include_file="$REPO_DIR/prompts/partials/instructions/${BASH_REMATCH[1]}.md"
        user_augment="$REPO_DIR/user/prompts/partials/instructions/${BASH_REMATCH[1]}.md"

        if [[ -f "$user_augment" ]] && head -1 "$user_augment" | grep -q "^@override"; then
            tail -n +2 "$user_augment" | awk 'NF {p=1} p'
        elif [[ -f "$include_file" ]]; then
            tail -n +2 "$include_file" | awk 'NF {p=1} p'
            if [[ -f "$user_augment" ]]; then
                tail -n +2 "$user_augment" | awk 'NF {p=1} p'
            fi
        else
            echo "$line"
        fi
    else
        echo "$line"
    fi
done < "$src_claude" > "$tmp_instr"

# Build restrictions from settings (modular + user)
{
    echo "## Enforced Restrictions"
    echo ""

    # Collect and deduplicate deny rules from all sources
    {
        # Base settings (security-sensitive paths)
        jq -r '.permissions.deny[]' "$src_settings" 2>/dev/null

        # Modular settings files (all .json files in settings/partials/)
        for json_file in "$REPO_DIR/settings/partials"/*.json; do
            if [[ -f "$json_file" ]]; then
                jq -r '.permissions.deny[]' "$json_file" 2>/dev/null
            fi
        done

        # User augmentation settings (all .json files in user/settings/partials/)
        for json_file in "$REPO_DIR/user/settings/partials"/*.json; do
            if [[ -f "$json_file" ]]; then
                jq -r '.permissions.deny[]' "$json_file" 2>/dev/null
            fi
        done

        # Project-local runtime settings if they exist
        if [[ -f "./.claude/settings.local.json" ]]; then
            jq -r '.permissions.deny[]' "./.claude/settings.local.json" 2>/dev/null
        fi
    } | sort -u | while read -r rule; do
        case "$rule" in
            Bash\(*) cmd="${rule#Bash(}"; cmd="${cmd%:*)}"; echo "- Never run '$cmd' or any command matching it." ;;
            Read\(*) path="${rule#Read(}"; path="${path%)}"; echo "- Never read files matching $path." ;;
            Edit\(*) path="${rule#Edit(}"; path="${path%)}"; echo "- Never edit files matching $path." ;;
            Write\(*) path="${rule#Write(}"; path="${path%)}"; echo "- Never write to files matching $path." ;;
            Glob\(*) path="${rule#Glob(}"; path="${path%)}"; echo "- Never enumerate file paths matching $path." ;;
            *) echo "- Deny: $rule" ;;
        esac
    done
} > "$tmp_restr"

# Replace @agent-title in instructions content
sed -i "s/@agent-title/# Codex Agent Configuration/" "$tmp_instr"

# Replace templates in base-AGENTS.md
cp "$src_template" "$tmp_out"

# Handle @local-claude
if [[ -s "$tmp_local" ]]; then
    sed -i "/@local-claude/r $tmp_local" "$tmp_out"
fi
sed -i "/@local-claude/d" "$tmp_out"

# Handle @instructions and @restrictions
sed -i "/@instructions/r $tmp_instr" "$tmp_out"
sed -i "/@instructions/d" "$tmp_out"
sed -i "/@restrictions/r $tmp_restr" "$tmp_out"
sed -i "/@restrictions/d" "$tmp_out"

mv "$tmp_out" AGENTS.md

echo "Generated AGENTS.md from agent-configs"
