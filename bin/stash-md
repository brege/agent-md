#!/bin/bash

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "Usage: stash-md <filename>"
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

filename="$1"
source_file="$PWD/$filename"

# Use environment variable if set, otherwise use the agent-md repo
# where the script is installed
agent_configs_dir="${AGENT_CONFIGS_DIR:-$REPO_DIR}"

# Build destination directory with context prefix
if [[ "$PWD" == "$HOME"* ]]; then
    # Home-relative path
    rel_path="${PWD#$HOME/}"
    dest_dir="$agent_configs_dir/user/src/$rel_path"
else
    # Root-relative path: use _ prefix for absolute paths
    rel_path="${PWD#/}"
    dest_dir="$agent_configs_dir/user/src/_/$rel_path"
fi
dest_file="$dest_dir/$filename"

if [ ! -f "$source_file" ]; then
    echo "Error: $source_file not found"
    exit 1
fi

mkdir -p "$dest_dir"
ln -s "$source_file" "$dest_file"
echo "Linked: $source_file â†’ $dest_file"
