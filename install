#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TARGET_DIR="/usr/local/bin"
INSTALL_TYPE="all"

# Parse arguments
for arg in "$@"; do
    case "$arg" in
        --claude)
            INSTALL_TYPE="claude"
            ;;
        --codex)
            INSTALL_TYPE="codex"
            ;;
        --all)
            INSTALL_TYPE="all"
            ;;
        /*)
            TARGET_DIR="$arg"
            ;;
        *)
            echo "usage: $0 [--claude|--codex|--all] [target-dir]" >&2
            echo "  --claude    install only claude-md" >&2
            echo "  --codex     install only codex-md" >&2
            echo "  --all       install both (default)" >&2
            echo "  target-dir  installation directory (default: /usr/local/bin)" >&2
            exit 1
            ;;
    esac
done

if [[ ! -d "$TARGET_DIR" ]]; then
    echo "error: destination $TARGET_DIR does not exist" >&2
    exit 1
fi

# Determine which scripts to install
scripts=()
case "$INSTALL_TYPE" in
    claude)
        scripts=("claude-md")
        ;;
    codex)
        scripts=("codex-md")
        ;;
    all)
        scripts=("claude-md" "codex-md")
        ;;
esac
installed=()

for script in "${scripts[@]}"; do
    src="$SCRIPT_DIR/$script"
    dest="$TARGET_DIR/$script"

    if [[ ! -f "$src" ]]; then
        echo "error: source script not found: $src" >&2
        exit 1
    fi

    # Check if symlink is correct
    if [[ ! -L "$dest" ]] || [[ "$(readlink "$dest")" != "$src" ]]; then
        rm -f "$dest"
        ln -s "$src" "$dest"
        echo "[+] Installed: $script"
        installed+=("$script")
    else
        echo "[-] Already linked: $script"
    fi
done

# Check if in PATH
if [[ ":$PATH:" != *":$TARGET_DIR:"* ]]; then
    echo ""
    echo "warning: $TARGET_DIR is not in your PATH"
    echo "add this to your shell config:"
    echo "    export PATH=\"$TARGET_DIR:\$PATH\""
else
    echo ""
    echo "âœ“ $TARGET_DIR is in PATH"
fi

if [[ ${#installed[@]} -gt 0 ]]; then
    echo ""
    echo "installed: ${installed[*]}"
fi
