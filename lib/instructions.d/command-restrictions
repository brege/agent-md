#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later
# Generate command-restrictions.md from settings.json deny rules

set -euo pipefail

REPO_DIR="${1:?REPO_DIR required}"
CLAUDE_DIR="${2:?CLAUDE_DIR required}"

settings_file="$CLAUDE_DIR/settings.json"
dest="$CLAUDE_DIR/instructions/command-restrictions.md"
dist_file="$REPO_DIR/dist/instructions/command-restrictions.md"
user_file="$REPO_DIR/user/instructions/command-restrictions.md"

base_tmp="$(mktemp)"
restr_tmp="$(mktemp)"
trap 'rm -f "$base_tmp" "$restr_tmp"' EXIT

if [[ -f "$user_file" ]] && head -1 "$user_file" | grep -q "^@override"; then
    tail -n +2 "$user_file" > "$base_tmp"
else
    base_included=false
    if [[ -f "$dist_file" ]]; then
        cat "$dist_file" >> "$base_tmp"
        base_included=true
    fi

    if [[ -f "$user_file" ]]; then
        if [[ "$base_included" == true ]]; then
            echo "" >> "$base_tmp"
        fi
        cat "$user_file" >> "$base_tmp"
    fi
fi

deny_rules=()
if [[ -f "$settings_file" ]]; then
    mapfile -t deny_rules < <(jq -r '.permissions?.deny[]?' "$settings_file" 2>/dev/null | sort -u)
fi

if ((${#deny_rules[@]} > 0)); then
    {
        for rule in "${deny_rules[@]}"; do
            case "$rule" in
                Bash\(*) cmd="${rule#Bash(}"; cmd="${cmd%:*)}"; echo "- Never run '$cmd' or any command matching it." ;;
                Read\(*) path="${rule#Read(}"; path="${path%)}"; echo "- Never read files matching $path." ;;
                Edit\(*) path="${rule#Edit(}"; path="${path%)}"; echo "- Never edit files matching $path." ;;
                Write\(*) path="${rule#Write(}"; path="${path%)}"; echo "- Never write to files matching $path." ;;
                Glob\(*) path="${rule#Glob(}"; path="${path%)}"; echo "- Never enumerate file paths matching $path." ;;
                *) echo "- Deny: $rule" ;;
            esac
        done
    } > "$restr_tmp"
fi

{
    if [[ -s "$base_tmp" ]]; then
        cat "$base_tmp"
        if [[ -s "$restr_tmp" ]]; then
            echo ""
        fi
    fi

    if [[ -s "$restr_tmp" ]]; then
        echo "## Enforced Restrictions"
        echo ""
        cat "$restr_tmp"
    fi
} > "$dest"
