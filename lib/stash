#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later
# Stash files into user/src directory with symlinks or backups

set -euo pipefail

REPO_DIR="${1:?REPO_DIR required}"
shift

if [[ $# -eq 0 ]]; then
    echo "Usage: lib/stash <REPO_DIR> <filename> [<filename> ...]"
    exit 1
fi

agent_configs_dir="${AGENT_CONFIGS_DIR:-$REPO_DIR}"

for filename in "$@"; do
    source_file="$PWD/$filename"

    if [[ "$PWD" == "$HOME"* ]]; then
        rel_path="${PWD#$HOME/}"
        dest_dir="$agent_configs_dir/user/src/$rel_path"
    else
        rel_path="${PWD#/}"
        dest_dir="$agent_configs_dir/user/src/_/$rel_path"
    fi
    dest_file="$dest_dir/$filename"

    if [ ! -f "$source_file" ]; then
        echo "Error: $source_file not found"
        exit 1
    fi

    mkdir -p "$dest_dir"
    mkdir -p "$(dirname "$dest_file")"

    if [ -L "$dest_file" ]; then
        if [ "$(readlink "$dest_file")" = "$source_file" ]; then
            echo "Already linked: $source_file → $dest_file"
        else
            counter=1
            backup_base="$dest_dir/$(basename "$filename")"
            while [ -f "$backup_base.$counter" ] || [ -L "$backup_base.$counter" ]; do
                counter=$((counter + 1))
            done
            cp "$source_file" "$backup_base.$counter"
            echo "Saved copy: $source_file → $backup_base.$counter"
        fi
    elif [ -e "$dest_file" ]; then
        if cmp -s "$source_file" "$dest_file"; then
            echo "Content unchanged: $source_file ↔ $dest_file"
        else
            counter=1
            backup_base="$dest_dir/$(basename "$filename")"
            while [ -f "$backup_base.$counter" ] || [ -L "$backup_base.$counter" ]; do
                counter=$((counter + 1))
            done
            cp "$source_file" "$backup_base.$counter"
            echo "Saved copy: $source_file → $backup_base.$counter"
        fi
    else
        ln -s "$source_file" "$dest_file"
        echo "Linked: $source_file → $dest_file"
    fi
done
